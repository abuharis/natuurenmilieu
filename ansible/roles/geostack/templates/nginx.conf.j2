server {
    listen 80;
    server_name {{ geostack_domain }};

    # Redirect all traffic to HTTPS except for certbot challenge
    location / {
        return 301 https://$server_name$request_uri;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}


server {
    listen 443 ssl;
    server_name {{ geostack_domain }};

    ssl_certificate /etc/letsencrypt/live/{{ geostack_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ geostack_domain }}/privkey.pem;


    # Proxy requests for GeoServer
    location /geoserver {
    proxy_pass http://geoserver:8080/geoserver;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Forwarded "proto=https;host=$host";

    location /geoserver {
    proxy_pass http://geoserver:8080/geoserver;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port 443;
    proxy_set_header X-Forwarded-Host $host;

    # Optional: remove backend CSP if you handle it here
    proxy_hide_header Content-Security-Policy;

    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        form-action 'self';
    " always;

#    sub_filter 'http://{{ geostack_domain }}' 'https://{{ geostack_domain }}';
#    sub_filter_once off;
#    proxy_set_header Accept-Encoding "";  # needed because sub_filter can't work with gzipped responses
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; form-action 'self' https:;" always;
    # Remove GeoServer CSP completely
#    proxy_hide_header Content-Security-Policy;
#    add_header Content-Security-Policy "";  # effectively disables CSP for this location
}

    # Handle requests for dataviewer at /
    location / {
        proxy_pass http://dataviewer:8090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header x-cache-status $upstream_cache_status;
        add_header cache-control "public, max-age=18000";

        # enable caching
        #proxy_cache my_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_bypass $http_cache_control;
    }

    # LetsEncrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location /healthz {
        return 200 'ok';
        add_header Content-Type text/plain;
    }
}